{% extends "base.html" %}

{% block title %}ãƒ¬ã‚·ãƒ”æ¤œç´¢ - ãƒ¬ã‚·ãƒ”æ¤œç´¢ã‚¢ãƒ—ãƒª{% endblock %}
{% block page_title %}ãƒ¬ã‚·ãƒ”æ¤œç´¢{% endblock %}



{% block content %}
<!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="section-card">
    <div class="section-title">ğŸ” ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢</div>
    <form method="POST" class="search-form">
        <div class="mb-3">
            <label for="query" class="form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
            <input type="text" name="query" id="query" class="form-control" 
                   placeholder="ä¾‹: ã‚«ãƒ¬ãƒ¼ã€ãƒ‘ã‚¹ã‚¿ã€ã‚¹ãƒ¼ãƒ—ãªã©" autocomplete="off">
        </div>
        
        {% if ingredients %}
            <div class="mb-3">
                <label class="form-label">ä½¿ã„ãŸã„é£Ÿæã‚’é¸æŠ</label>
                <div class="ingredient-list">
                    {% for ing in ingredients %}
                        {% set color_class = "" %}
                        {% if ing.expiry_date %}
                            {% set days_left = (ing.expiry_date - date.today()).days %}
                            {% if days_left < 0 %}
                                {% set color_class = "text-danger fw-bold" %}
                            {% elif days_left <= 3 %}
                                {% set color_class = "text-danger" %}
                            {% elif days_left <= 7 %}
                                {% set color_class = "text-warning" %}
                            {% else %}
                                {% set color_class = "text-success" %}
                            {% endif %}
                        {% endif %}
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" 
                                   name="selected_ingredients" value="{{ ing.name }}" 
                                   id="ing-{{ ing.id }}">
                            <label class="form-check-label {{ color_class }}" for="ing-{{ ing.id }}">
                                {{ ing.name }}
                                {% if ing.expiry_date %}
                                    ({{ ing.expiry_date.strftime("%m/%d") }})
                                {% endif %}
                                Ã— {{ ing.quantity }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
                <small class="text-muted">æœŸé™ãŒè¿‘ã„é£Ÿæã¯èµ¤è‰²ã§è¡¨ç¤ºã•ã‚Œã¾ã™</small>
            </div>
        {% else %}
            <div class="no-ingredients-notice mb-3">
                <h6 class="text-white mb-2">é£ŸæãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h6>
                <p class="mb-3">ã¾ãšã¯é£Ÿæã‚’ç™»éŒ²ã—ã¦ã€ã‚ˆã‚Šä¾¿åˆ©ã«æ¤œç´¢ã—ã¾ã—ã‚‡ã†ã€‚</p>
                <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-light">
                    é£Ÿæã‚’ç™»éŒ²ã™ã‚‹
                </a>
            </div>
        {% endif %}
        
        <button type="submit" class="btn btn-success btn-search w-100">
            ğŸ” ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢
        </button>
    </form>
</div>

<!-- æ¤œç´¢ã®ãƒ’ãƒ³ãƒˆ -->
{% if not results %}
    <div class="section-card">
        <div class="section-title">ğŸ’¡ æ¤œç´¢ã®ãƒ’ãƒ³ãƒˆ</div>
        <ul class="list-unstyled">
            <li class="mb-2">ğŸ¥• <strong>é£Ÿæåã§æ¤œç´¢:</strong> å†·è”µåº«ã«ã‚ã‚‹é£Ÿæã‚’é¸æŠã—ã¦æ¤œç´¢</li>
            <li class="mb-2">ğŸœ <strong>æ–™ç†åã§æ¤œç´¢:</strong> ã€Œã‚«ãƒ¬ãƒ¼ã€ã€Œãƒ‘ã‚¹ã‚¿ã€ãªã©ä½œã‚ŠãŸã„æ–™ç†å</li>
            <li class="mb-2">ğŸ”¥ <strong>èª¿ç†æ³•ã§æ¤œç´¢:</strong> ã€Œç‚’ã‚ç‰©ã€ã€Œç…®ç‰©ã€ã€Œã‚¹ãƒ¼ãƒ—ã€ãªã©</li>
            <li class="mb-2">â° <strong>æ™‚çŸ­ãƒ¬ã‚·ãƒ”:</strong> ã€Œ10åˆ†ã€ã€Œç°¡å˜ã€ãªã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</li>
        </ul>
    </div>
{% endif %}

<!-- æ¤œç´¢çµæœ -->
{% if results %}
    <div class="section-card">
        <div class="section-title">ğŸ½ï¸ æ¤œç´¢çµæœ</div>
        <div class="results-info">
            <span id="visible-count">0</span>ä»¶è¡¨ç¤ºä¸­ / å…¨<span id="total-count">{{ results|length }}</span>ä»¶
        </div>
        <div class="row g-2" id="recipe-container">
            {% for r in results %}
                <div class="col-6 recipe-item">
                    <div class="card recipe-card h-100">
                        {% if r.img %}
                            <img src="{{ r.img }}" class="card-img-top" alt="{{ r.title }}" loading="lazy">
                        {% endif %}
                        <div class="card-body p-2">
                            <h6 class="card-title">{{ r.title }}</h6>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="badge bg-info">{{ r.source }}</span>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ r.url }}" 
                                            class="btn btn-primary btn-sm" 
                                            target="_blank" 
                                            rel="noopener"
                                            onclick="recordView(this.dataset.recipe)" 
                                            data-recipe='{{ {"title": r.title, "url": r.url, "img": r.img, "source": r.source}|tojson }}'>
                                            é–‹ã
                                        </a>
                                        <button type="button" 
                                            class="btn btn-outline-danger btn-sm"
                                            onclick="toggleFavorite(this)"
                                            data-recipe='{{ {"title": r.title, "url": r.url, "img": r.img, "source": r.source}|tojson }}'>
                                            â¤ï¸
                                        </button>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="show-more-container">
            <button id="load-more-btn" class="btn btn-show-more" onclick="showMore()">
                ã‚‚ã£ã¨è¦‹ã‚‹
            </button>
        </div>
        
        <!-- æ–°ã—ã„æ¤œç´¢ãƒœã‚¿ãƒ³ -->
        <div class="text-center mt-3">
            <a href="{{ url_for('recipe_app.search') }}" class="btn btn-outline-primary">
                æ–°ã—ã„æ¤œç´¢
            </a>
        </div>
    </div>
{% endif %}

<!-- é£ŸæãŒãªã„å ´åˆã®æ¡ˆå†… -->
{% if not ingredients %}
    <div class="section-card">
        <div class="section-title">ğŸ“ ã‚ˆã‚Šä¾¿åˆ©ã«æ¤œç´¢ã™ã‚‹ãŸã‚ã«</div>
        <p class="mb-3">é£Ÿæã‚’ç™»éŒ²ã™ã‚‹ã¨ã€å†·è”µåº«ã«ã‚ã‚‹ã‚‚ã®ã‹ã‚‰ç›´æ¥ãƒ¬ã‚·ãƒ”ã‚’æ¢ã›ã¾ã™ã€‚</p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-success">
                é£Ÿæã‚’ç™»éŒ²
            </a>
            <a href="{{ url_for('recipe_app.refrigerator') }}" class="btn btn-outline-primary">
                å†·è”µåº«ã‚’è¦‹ã‚‹
            </a>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
// Jinjaãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å¿…è¦ãªå€¤ã‚’JavaScriptã«æ¸¡ã™
{% if ingredients %}
window.hasIngredients = true;
window.ingredientsCount = {{ ingredients|length }};
{% else %}
window.hasIngredients = false;
window.ingredientsCount = 0;
{% endif %}

{% if results %}
window.hasResults = true;
window.totalResults = {{ results|length }};
{% else %}
window.hasResults = false;
window.totalResults = 0;
{% endif %}
</script>

<script type="text/javascript">
// ãƒ¬ã‚·ãƒ”è¡¨ç¤ºåˆ¶å¾¡ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é…ç½®ï¼‰
const step = 8;
let visibleCount = 0;

// UIæ›´æ–°é–¢æ•°
function updateUI() {
    const visibleCountSpan = document.getElementById('visible-count');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const totalCount = document.querySelectorAll('.recipe-item').length;
    
    if (visibleCountSpan) {
        visibleCountSpan.textContent = visibleCount;
    }
    
    if (loadMoreBtn) {
        if (visibleCount >= totalCount) {
            loadMoreBtn.style.display = 'none';
            console.log('All recipes shown, hiding button');
        } else {
            loadMoreBtn.style.display = 'block';
            console.log('Button visible: ' + visibleCount + '/' + totalCount);
        }
    }
}

// åˆæœŸè¡¨ç¤ºè¨­å®š
function initializeRecipeDisplay() {
    const allItems = document.querySelectorAll('.recipe-item');
    const totalCount = allItems.length;
    
    if (totalCount === 0) {
        console.log('No recipes to display');
        return;
    }

    console.log('initializeRecipeDisplay() called for ' + totalCount + ' recipes');
    
    visibleCount = 0;
    const initialShow = Math.min(step, totalCount);
    
    for (let i = 0; i < totalCount; i++) {
        const item = allItems[i];
        if (i < initialShow) {
            item.classList.add('show');
            console.log('Showing initial item ' + (i + 1));
        } else {
            item.classList.remove('show');
        }
    }
    
    visibleCount = initialShow;
    updateUI();
    
    console.log('Initial display complete: showing ' + visibleCount + '/' + totalCount + ' recipes');
}

// ã‚‚ã£ã¨è¦‹ã‚‹æ©Ÿèƒ½
function showMore() {
    const allItems = document.querySelectorAll('.recipe-item');
    const totalCount = allItems.length;

    console.log('showMore() called: Current visible: ' + visibleCount + ', Total: ' + totalCount);

    if (visibleCount >= totalCount) {
        console.log('All recipes already shown');
        return;
    }

    const maxShow = Math.min(visibleCount + step, totalCount);

    for (let i = visibleCount; i < maxShow; i++) {
        if (allItems[i]) {
            allItems[i].classList.add('show');
            console.log('Showing additional item ' + (i + 1));
        }
    }

    const oldVisibleCount = visibleCount;
    visibleCount = maxShow;
    updateUI();

    console.log('Updated: ' + oldVisibleCount + ' â†’ ' + visibleCount + '/' + totalCount + ' recipes');
}

// é£Ÿæé¸æŠã®ä¾¿åˆ©é–¢æ•°
function selectAllIngredients() {
    const checkboxes = document.querySelectorAll('.form-check-input[name="selected_ingredients"]');
    checkboxes.forEach(function(cb) {
        cb.checked = true;
    });
    console.log('All ingredients selected');
}

function unselectAllIngredients() {
    const checkboxes = document.querySelectorAll('.form-check-input[name="selected_ingredients"]');
    checkboxes.forEach(function(cb) {
        cb.checked = false;
    });
    console.log('All ingredients unselected');
}

function selectUrgentIngredients() {
    const checkboxes = document.querySelectorAll('.form-check-input[name="selected_ingredients"]');
    let selectedCount = 0;
    
    checkboxes.forEach(function(checkbox) {
        const label = checkbox.nextElementSibling;
        if (label && (label.classList.contains('text-danger') || label.classList.contains('text-warning'))) {
            checkbox.checked = true;
            selectedCount++;
        } else {
            checkbox.checked = false;
        }
    });
    
    console.log(selectedCount + ' urgent ingredients selected');
}

// DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('DOMContentLoaded', function() {
    console.log('Search page loaded');
    
    const allItems = document.querySelectorAll('.recipe-item');
    
    console.log('Available ingredients: ' + window.ingredientsCount);
    console.log('Total recipes: ' + allItems.length);

    // ãƒ¬ã‚·ãƒ”è¡¨ç¤ºã‚’åˆæœŸåŒ–
    if (allItems.length > 0) {
        console.log('Starting recipe display initialization...');
        
        let visibleBefore = 0;
        allItems.forEach(function(item) {
            const computed = window.getComputedStyle(item);
            if (computed.display !== 'none') {
                visibleBefore++;
            }
        });
        console.log('Before initialization: ' + visibleBefore + ' items visible');
        
        initializeRecipeDisplay();
        
        setTimeout(function() {
            let visibleAfter = 0;
            allItems.forEach(function(item, index) {
                const computed = window.getComputedStyle(item);
                const hasShowClass = item.classList.contains('show');
                console.log('Item ' + (index + 1) + ': show class=' + hasShowClass + ', computed display=' + computed.display);
                if (computed.display !== 'none') {
                    visibleAfter++;
                }
            });
            console.log('After initialization: ' + visibleAfter + ' items visible');
        }, 100);
    }

    // æœŸé™ãŒè¿‘ã„é£Ÿæã®çµ±è¨ˆ
    const urgentIngredients = document.querySelectorAll('.text-danger, .text-warning');
    if (urgentIngredients.length > 0) {
        console.log(urgentIngredients.length + ' ingredients expiring soon');
    }

    // ä¾¿åˆ©ãƒœã‚¿ãƒ³ã‚’å‹•çš„è¿½åŠ 
    const ingredientList = document.querySelector('.ingredient-list');
    const existingControls = document.querySelector('.ingredient-controls');
    const hasUrgentIngredients = urgentIngredients.length > 0;
    
    if (ingredientList && window.ingredientsCount > 0 && !existingControls) {
        const controlDiv = document.createElement('div');
        controlDiv.className = 'mb-2 ingredient-controls';
        
        const button1 = document.createElement('button');
        button1.type = 'button';
        button1.className = 'btn btn-sm btn-outline-primary me-1';
        button1.textContent = 'å…¨é¸æŠ';
        button1.onclick = selectAllIngredients;
        
        const button2 = document.createElement('button');
        button2.type = 'button';
        button2.className = 'btn btn-sm btn-outline-secondary me-1';
        button2.textContent = 'å…¨è§£é™¤';
        button2.onclick = unselectAllIngredients;
        
        controlDiv.appendChild(button1);
        controlDiv.appendChild(button2);
        
        if (hasUrgentIngredients) {
            const button3 = document.createElement('button');
            button3.type = 'button';
            button3.className = 'btn btn-sm btn-outline-warning';
            button3.textContent = 'æœŸé™é–“è¿‘ã®ã¿';
            button3.onclick = selectUrgentIngredients;
            controlDiv.appendChild(button3);
        }
        
        ingredientList.parentNode.insertBefore(controlDiv, ingredientList);
        console.log('Control buttons added');
    }

    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
        console.log('Load more button found');
        
        loadMoreBtn.addEventListener('click', function() {
            console.log('Load more button clicked!');
        });
    }
});

// ãŠæ°—ã«å…¥ã‚Šã®ãƒˆã‚°ãƒ«
function toggleFavorite(button) {
    const recipe = JSON.parse(button.dataset.recipe);
    const formData = new FormData();
    formData.append('title', recipe.title);
    formData.append('url', recipe.url);
    formData.append('img', recipe.img || '');
    formData.append('source', recipe.source);
    
    fetch('{{ url_for("recipe_app.add_favorite") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.ok)
    .then(success => {
        if (success) {
            button.textContent = button.textContent === 'â¤ï¸' ? 'ğŸ¤' : 'â¤ï¸';
            console.log('Favorite toggled:', recipe.title);
        }
    })
    .catch(error => console.error('Favorite error:', error));
}

// é–²è¦§å±¥æ­´ã‚’è¨˜éŒ²
function recordView(recipeData) {
    const recipe = JSON.parse(recipeData);
    const formData = new FormData();
    formData.append('title', recipe.title);
    formData.append('url', recipe.url);
    formData.append('img', recipe.img || '');
    formData.append('source', recipe.source);
    
    fetch('{{ url_for("recipe_app.record_view") }}', {
        method: 'POST',
        body: formData
    }).catch(error => console.error('Record view error:', error));
}
</script>
{% endblock %}