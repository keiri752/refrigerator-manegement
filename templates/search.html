{% extends "base.html" %}

{% block title %}レシピ検索 - レシピ検索アプリ{% endblock %}
{% block page_title %}レシピ検索{% endblock %}



{% block content %}
<!-- 検索フォーム -->
<div class="section-card">
    <div class="section-title">🔍 レシピを検索</div>
    <form method="POST" class="search-form">
        <div class="mb-3">
            <label for="query" class="form-label">キーワード検索</label>
            <input type="text" name="query" id="query" class="form-control" 
                   placeholder="例: カレー、パスタ、スープなど" autocomplete="off">
        </div>
        
        {% if ingredients %}
            <div class="mb-3">
                <label class="form-label">使いたい食材を選択</label>
                <div class="ingredient-list">
                    {% for ing in ingredients %}
                        {% set color_class = "" %}
                        {% if ing.expiry_date %}
                            {% set days_left = (ing.expiry_date - date.today()).days %}
                            {% if days_left < 0 %}
                                {% set color_class = "text-danger fw-bold" %}
                            {% elif days_left <= 3 %}
                                {% set color_class = "text-danger" %}
                            {% elif days_left <= 7 %}
                                {% set color_class = "text-warning" %}
                            {% else %}
                                {% set color_class = "text-success" %}
                            {% endif %}
                        {% endif %}
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" 
                                   name="selected_ingredients" value="{{ ing.name }}" 
                                   id="ing-{{ ing.id }}">
                            <label class="form-check-label {{ color_class }}" for="ing-{{ ing.id }}">
                                {{ ing.name }}
                                {% if ing.expiry_date %}
                                    ({{ ing.expiry_date.strftime("%m/%d") }})
                                {% endif %}
                                × {{ ing.quantity }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
                <small class="text-muted">期限が近い食材は赤色で表示されます</small>
            </div>
        {% else %}
            <div class="no-ingredients-notice mb-3">
                <h6 class="text-white mb-2">食材が登録されていません</h6>
                <p class="mb-3">まずは食材を登録して、より便利に検索しましょう。</p>
                <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-light">
                    食材を登録する
                </a>
            </div>
        {% endif %}
        
        <button type="submit" class="btn btn-success btn-search w-100">
            🔍 レシピを検索
        </button>
    </form>
</div>

<!-- 検索のヒント -->
{% if not results %}
    <div class="section-card">
        <div class="section-title">💡 検索のヒント</div>
        <ul class="list-unstyled">
            <li class="mb-2">🥕 <strong>食材名で検索:</strong> 冷蔵庫にある食材を選択して検索</li>
            <li class="mb-2">🍜 <strong>料理名で検索:</strong> 「カレー」「パスタ」など作りたい料理名</li>
            <li class="mb-2">🔥 <strong>調理法で検索:</strong> 「炒め物」「煮物」「スープ」など</li>
            <li class="mb-2">⏰ <strong>時短レシピ:</strong> 「10分」「簡単」などのキーワード</li>
        </ul>
    </div>
{% endif %}

<!-- 検索結果 -->
{% if results %}
    <div class="section-card">
        <div class="section-title">🍽️ 検索結果</div>
        <div class="results-info">
            <span id="visible-count">0</span>件表示中 / 全<span id="total-count">{{ results|length }}</span>件
        </div>
        <div class="row g-2" id="recipe-container">
            {% for r in results %}
                <div class="col-6 recipe-item">
                    <div class="card recipe-card h-100">
                        {% if r.img %}
                            <img src="{{ r.img }}" class="card-img-top" alt="{{ r.title }}" loading="lazy">
                        {% endif %}
                        <div class="card-body p-2">
                            <h6 class="card-title">{{ r.title }}</h6>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="badge bg-info">{{ r.source }}</span>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ r.url }}" 
                                            class="btn btn-primary btn-sm" 
                                            target="_blank" 
                                            rel="noopener"
                                            onclick="recordView(this.dataset.recipe)" 
                                            data-recipe='{{ {"title": r.title, "url": r.url, "img": r.img, "source": r.source}|tojson }}'>
                                            開く
                                        </a>
                                        <button type="button" 
                                            class="btn btn-outline-danger btn-sm"
                                            onclick="toggleFavorite(this)"
                                            data-recipe='{{ {"title": r.title, "url": r.url, "img": r.img, "source": r.source}|tojson }}'>
                                            ❤️
                                        </button>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="show-more-container">
            <button id="load-more-btn" class="btn btn-show-more" onclick="showMore()">
                もっと見る
            </button>
        </div>
        
        <!-- 新しい検索ボタン -->
        <div class="text-center mt-3">
            <a href="{{ url_for('recipe_app.search') }}" class="btn btn-outline-primary">
                新しい検索
            </a>
        </div>
    </div>
{% endif %}

<!-- 食材がない場合の案内 -->
{% if not ingredients %}
    <div class="section-card">
        <div class="section-title">📝 より便利に検索するために</div>
        <p class="mb-3">食材を登録すると、冷蔵庫にあるものから直接レシピを探せます。</p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-success">
                食材を登録
            </a>
            <a href="{{ url_for('recipe_app.refrigerator') }}" class="btn btn-outline-primary">
                冷蔵庫を見る
            </a>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
// Jinjaテンプレートから必要な値をJavaScriptに渡す
{% if ingredients %}
window.hasIngredients = true;
window.ingredientsCount = {{ ingredients|length }};
{% else %}
window.hasIngredients = false;
window.ingredientsCount = 0;
{% endif %}

{% if results %}
window.hasResults = true;
window.totalResults = {{ results|length }};
{% else %}
window.hasResults = false;
window.totalResults = 0;
{% endif %}
</script>

<script type="text/javascript">
// レシピ表示制御（グローバルスコープに配置）
const step = 8;
let visibleCount = 0;

// UI更新関数
function updateUI() {
    const visibleCountSpan = document.getElementById('visible-count');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const totalCount = document.querySelectorAll('.recipe-item').length;
    
    if (visibleCountSpan) {
        visibleCountSpan.textContent = visibleCount;
    }
    
    if (loadMoreBtn) {
        if (visibleCount >= totalCount) {
            loadMoreBtn.style.display = 'none';
            console.log('All recipes shown, hiding button');
        } else {
            loadMoreBtn.style.display = 'block';
            console.log('Button visible: ' + visibleCount + '/' + totalCount);
        }
    }
}

// 初期表示設定
function initializeRecipeDisplay() {
    const allItems = document.querySelectorAll('.recipe-item');
    const totalCount = allItems.length;
    
    if (totalCount === 0) {
        console.log('No recipes to display');
        return;
    }

    console.log('initializeRecipeDisplay() called for ' + totalCount + ' recipes');
    
    visibleCount = 0;
    const initialShow = Math.min(step, totalCount);
    
    for (let i = 0; i < totalCount; i++) {
        const item = allItems[i];
        if (i < initialShow) {
            item.classList.add('show');
            console.log('Showing initial item ' + (i + 1));
        } else {
            item.classList.remove('show');
        }
    }
    
    visibleCount = initialShow;
    updateUI();
    
    console.log('Initial display complete: showing ' + visibleCount + '/' + totalCount + ' recipes');
}

// もっと見る機能
function showMore() {
    const allItems = document.querySelectorAll('.recipe-item');
    const totalCount = allItems.length;

    console.log('showMore() called: Current visible: ' + visibleCount + ', Total: ' + totalCount);

    if (visibleCount >= totalCount) {
        console.log('All recipes already shown');
        return;
    }

    const maxShow = Math.min(visibleCount + step, totalCount);

    for (let i = visibleCount; i < maxShow; i++) {
        if (allItems[i]) {
            allItems[i].classList.add('show');
            console.log('Showing additional item ' + (i + 1));
        }
    }

    const oldVisibleCount = visibleCount;
    visibleCount = maxShow;
    updateUI();

    console.log('Updated: ' + oldVisibleCount + ' → ' + visibleCount + '/' + totalCount + ' recipes');
}

// 食材選択の便利関数
function selectAllIngredients() {
    const checkboxes = document.querySelectorAll('.form-check-input[name="selected_ingredients"]');
    checkboxes.forEach(function(cb) {
        cb.checked = true;
    });
    console.log('All ingredients selected');
}

function unselectAllIngredients() {
    const checkboxes = document.querySelectorAll('.form-check-input[name="selected_ingredients"]');
    checkboxes.forEach(function(cb) {
        cb.checked = false;
    });
    console.log('All ingredients unselected');
}

function selectUrgentIngredients() {
    const checkboxes = document.querySelectorAll('.form-check-input[name="selected_ingredients"]');
    let selectedCount = 0;
    
    checkboxes.forEach(function(checkbox) {
        const label = checkbox.nextElementSibling;
        if (label && (label.classList.contains('text-danger') || label.classList.contains('text-warning'))) {
            checkbox.checked = true;
            selectedCount++;
        } else {
            checkbox.checked = false;
        }
    });
    
    console.log(selectedCount + ' urgent ingredients selected');
}

// DOMContentLoadedイベント
document.addEventListener('DOMContentLoaded', function() {
    console.log('Search page loaded');
    
    const allItems = document.querySelectorAll('.recipe-item');
    
    console.log('Available ingredients: ' + window.ingredientsCount);
    console.log('Total recipes: ' + allItems.length);

    // レシピ表示を初期化
    if (allItems.length > 0) {
        console.log('Starting recipe display initialization...');
        
        let visibleBefore = 0;
        allItems.forEach(function(item) {
            const computed = window.getComputedStyle(item);
            if (computed.display !== 'none') {
                visibleBefore++;
            }
        });
        console.log('Before initialization: ' + visibleBefore + ' items visible');
        
        initializeRecipeDisplay();
        
        setTimeout(function() {
            let visibleAfter = 0;
            allItems.forEach(function(item, index) {
                const computed = window.getComputedStyle(item);
                const hasShowClass = item.classList.contains('show');
                console.log('Item ' + (index + 1) + ': show class=' + hasShowClass + ', computed display=' + computed.display);
                if (computed.display !== 'none') {
                    visibleAfter++;
                }
            });
            console.log('After initialization: ' + visibleAfter + ' items visible');
        }, 100);
    }

    // 期限が近い食材の統計
    const urgentIngredients = document.querySelectorAll('.text-danger, .text-warning');
    if (urgentIngredients.length > 0) {
        console.log(urgentIngredients.length + ' ingredients expiring soon');
    }

    // 便利ボタンを動的追加
    const ingredientList = document.querySelector('.ingredient-list');
    const existingControls = document.querySelector('.ingredient-controls');
    const hasUrgentIngredients = urgentIngredients.length > 0;
    
    if (ingredientList && window.ingredientsCount > 0 && !existingControls) {
        const controlDiv = document.createElement('div');
        controlDiv.className = 'mb-2 ingredient-controls';
        
        const button1 = document.createElement('button');
        button1.type = 'button';
        button1.className = 'btn btn-sm btn-outline-primary me-1';
        button1.textContent = '全選択';
        button1.onclick = selectAllIngredients;
        
        const button2 = document.createElement('button');
        button2.type = 'button';
        button2.className = 'btn btn-sm btn-outline-secondary me-1';
        button2.textContent = '全解除';
        button2.onclick = unselectAllIngredients;
        
        controlDiv.appendChild(button1);
        controlDiv.appendChild(button2);
        
        if (hasUrgentIngredients) {
            const button3 = document.createElement('button');
            button3.type = 'button';
            button3.className = 'btn btn-sm btn-outline-warning';
            button3.textContent = '期限間近のみ';
            button3.onclick = selectUrgentIngredients;
            controlDiv.appendChild(button3);
        }
        
        ingredientList.parentNode.insertBefore(controlDiv, ingredientList);
        console.log('Control buttons added');
    }

    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
        console.log('Load more button found');
        
        loadMoreBtn.addEventListener('click', function() {
            console.log('Load more button clicked!');
        });
    }
});

// お気に入りのトグル
function toggleFavorite(button) {
    const recipe = JSON.parse(button.dataset.recipe);
    const formData = new FormData();
    formData.append('title', recipe.title);
    formData.append('url', recipe.url);
    formData.append('img', recipe.img || '');
    formData.append('source', recipe.source);
    
    fetch('{{ url_for("recipe_app.add_favorite") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.ok)
    .then(success => {
        if (success) {
            button.textContent = button.textContent === '❤️' ? '🤍' : '❤️';
            console.log('Favorite toggled:', recipe.title);
        }
    })
    .catch(error => console.error('Favorite error:', error));
}

// 閲覧履歴を記録
function recordView(recipeData) {
    const recipe = JSON.parse(recipeData);
    const formData = new FormData();
    formData.append('title', recipe.title);
    formData.append('url', recipe.url);
    formData.append('img', recipe.img || '');
    formData.append('source', recipe.source);
    
    fetch('{{ url_for("recipe_app.record_view") }}', {
        method: 'POST',
        body: formData
    }).catch(error => console.error('Record view error:', error));
}
</script>
{% endblock %}