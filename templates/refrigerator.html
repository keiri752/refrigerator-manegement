{% extends "base.html" %}

{% block title %}å†·è”µåº« - ãƒ¬ã‚·ãƒ”æ¤œç´¢ã‚¢ãƒ—ãƒª{% endblock %}
{% block page_title %}å†·è”µåº«{% endblock %}


{% block content %}
{% if ingredients %}
    <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <div class="bulk-actions-header">
            <div class="selected-count">
                <span id="selectedCount">0</span>ä»¶é¸æŠä¸­
            </div>
            <button class="btn btn-sm btn-light" onclick="clearSelection()">é¸æŠè§£é™¤</button>
        </div>
        <div class="bulk-action-buttons">
            <button class="btn btn-sm" onclick="openBulkCategoryModal()">
                ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´
            </button>
            <button class="btn btn-sm" onclick="openBulkQuantityModal()">
                ğŸ”¢ æ•°é‡å¤‰æ›´
            </button>
            <button class="btn btn-sm btn-danger" onclick="bulkDelete()">
                ğŸ—‘ï¸ ä¸€æ‹¬å‰Šé™¤
            </button>
        </div>
    </div>

    <!-- ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
    <div class="section-card">
        <div class="section-title">
            ğŸ”§ è¡¨ç¤ºé †åº
            <button class="btn btn-sm btn-outline-primary select-all-btn" onclick="toggleSelectAll()">
                <span id="selectAllText">å…¨é¸æŠ</span>
            </button>
        </div>
        <div class="sort-buttons">
            <a href="{{ url_for('recipe_app.refrigerator') }}" 
               class="btn {{ 'btn-primary' if not sort else 'btn-outline-secondary' }} btn-sm">
                ç™»éŒ²é †
            </a>
            <a href="{{ url_for('recipe_app.refrigerator', sort='expiry') }}" 
               class="btn {{ 'btn-primary' if sort == 'expiry' else 'btn-outline-secondary' }} btn-sm">
                è³å‘³æœŸé™é †
            </a>
            <a href="{{ url_for('recipe_app.refrigerator', sort='name') }}" 
               class="btn {{ 'btn-primary' if sort == 'name' else 'btn-outline-secondary' }} btn-sm">
                åå‰é †
            </a>
            <a href="{{ url_for('recipe_app.refrigerator', sort='quantity') }}" 
               class="btn {{ 'btn-primary' if sort == 'quantity' else 'btn-outline-secondary' }} btn-sm">
                æ•°é‡é †
            </a>
        </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
    <div class="section-card">
        <div class="category-tabs">
            <button class="category-tab all-tab active" onclick="showCategory('all')">
                ğŸ“¦ ã™ã¹ã¦
                <span class="badge">{{ ingredients|length }}</span>
            </button>
            
            {% for category in all_categories %}
                {% set category_items = grouped.get(category, []) %}
                {% if category_items %}
                <button class="category-tab" onclick="showCategory('{{ category }}')">
                    {% if category == 'é‡èœ' %}ğŸ¥•
                    {% elif category == 'è‚‰é¡' %}ğŸ¥©
                    {% elif category == 'é­šä»‹é¡' %}ğŸŸ
                    {% elif category == 'ä¹³è£½å“' %}ğŸ¥›
                    {% elif category == 'ç©€é¡' %}ğŸŒ¾
                    {% elif category == 'èª¿å‘³æ–™' %}ğŸ§‚
                    {% else %}ğŸ“¦
                    {% endif %}
                    {{ category }}
                    <span class="badge">{{ category_items|length }}</span>
                </button>
                {% endif %}
            {% endfor %}
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="tab-content">
            <!-- å…¨ã¦è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="category-all" class="category-section active">
                <div class="category-header">
                    <h3 class="category-title">ğŸ“¦ ã™ã¹ã¦ã®é£Ÿæ</h3>
                    <div class="category-stats">
                        åˆè¨ˆ {{ ingredients|length }} ç¨®é¡
                    </div>
                </div>
                
                {% for category, items in grouped.items() %}
                    <h5 class="mt-3">
                        {{ category }}
                        <small class="text-muted">({{ items|length }}ä»¶)</small>
                    </h5>
                    {% include 'ingredient_list.html' %}
                {% endfor %}
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            {% for category in all_categories %}
                {% set category_items = grouped.get(category, []) %}
                {% if category_items %}
                <div id="category-{{ category }}" class="category-section">
                    <div class="category-header">
                        <h3 class="category-title">
                            {% if category == 'é‡èœ' %}ğŸ¥•
                            {% elif category == 'è‚‰é¡' %}ğŸ¥©
                            {% elif category == 'é­šä»‹é¡' %}ğŸŸ
                            {% elif category == 'ä¹³è£½å“' %}ğŸ¥›
                            {% elif category == 'ç©€é¡' %}ğŸŒ¾
                            {% elif category == 'èª¿å‘³æ–™' %}ğŸ§‚
                            {% else %}ğŸ“¦
                            {% endif %}
                            {{ category }}
                        </h3>
                        <div class="category-stats">
                            {{ category_items|length }} ç¨®é¡ / 
                            {% set total_quantity = category_items|sum(attribute='quantity') %}
                            åˆè¨ˆ {{ total_quantity }} å€‹
                        </div>
                    </div>
                    
                    {% set items = category_items %}
                    {% include 'ingredient_list.html' %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- çµ±è¨ˆæƒ…å ± -->
    {% set ns = namespace(expired_count=0, expiring_soon_count=0, total_quantity=0) %}
    {% for ing in ingredients %}
        {% set ns.total_quantity = ns.total_quantity + ing.quantity %}
        {% if ing.expiry_date %}
            {% set days_left = (ing.expiry_date - date.today()).days %}
            {% if days_left < 0 %}
                {% set ns.expired_count = ns.expired_count + 1 %}
            {% elif days_left <= 3 %}
                {% set ns.expiring_soon_count = ns.expiring_soon_count + 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    
    <div class="section-card">
        <div class="section-title">ğŸ“Š çµ±è¨ˆæƒ…å ±</div>
        <div class="row text-center">
            <div class="col-6 col-md-3">
                <div class="fw-bold text-primary">{{ ingredients|length }}</div>
                <small class="text-muted">ç¨®é¡</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="fw-bold text-success">{{ ns.total_quantity }}</div>
                <small class="text-muted">ç·æ•°é‡</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="fw-bold text-warning">{{ ns.expiring_soon_count }}</div>
                <small class="text-muted">æœŸé™é–“è¿‘</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="fw-bold text-danger">{{ ns.expired_count }}</div>
                <small class="text-muted">æœŸé™åˆ‡ã‚Œ</small>
            </div>
        </div>
    </div>
    
    <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-card">
        <div class="section-title">ğŸš€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div class="d-grid gap-2 d-md-flex">
            <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-success">
                é£Ÿæã‚’è¿½åŠ 
            </a>
            <a href="{{ url_for('recipe_app.search') }}" class="btn btn-primary">
                ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢
            </a>
        </div>
    </div>
    
{% else %}
    <!-- ç©ºã®çŠ¶æ…‹ -->
    <div class="empty-state">
        <div class="empty-state-icon">â„ï¸</div>
        <h5>å†·è”µåº«ãŒç©ºã£ã½ã§ã™</h5>
        <p>ã¾ãšã¯é£Ÿæã‚’ç™»éŒ²ã—ã¦ã€<br>å†·è”µåº«ç®¡ç†ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>
        <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-primary">
            æœ€åˆã®é£Ÿæã‚’ç™»éŒ²
        </a>
    </div>
{% endif %}

<!-- ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="bulk-modal" id="bulkCategoryModal">
    <div class="bulk-modal-content">
        <div class="bulk-modal-header">ã‚«ãƒ†ã‚´ãƒªã‚’ä¸€æ‹¬å¤‰æ›´</div>
        <div class="bulk-modal-body">
            <form id="bulkCategoryForm" method="POST" action="{{ url_for('recipe_app.bulk_change_category') }}">
                <label class="form-label">å¤‰æ›´å…ˆã®ã‚«ãƒ†ã‚´ãƒª</label>
                <select name="new_category" class="form-select" required>
                    {% for cat in all_categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="ingredient_ids[]" id="bulkCategoryIds">
            </form>
        </div>
        <div class="bulk-modal-footer">
            <button class="btn btn-secondary" onclick="closeBulkCategoryModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="submitBulkCategory()">å¤‰æ›´</button>
        </div>
    </div>
</div>

<!-- æ•°é‡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="bulk-modal" id="bulkQuantityModal">
    <div class="bulk-modal-content">
        <div class="bulk-modal-header">æ•°é‡ã‚’ä¸€æ‹¬å¤‰æ›´</div>
        <div class="bulk-modal-body">
            <form id="bulkQuantityForm" method="POST" action="{{ url_for('recipe_app.bulk_change_quantity') }}">
                <label class="form-label">æ“ä½œ</label>
                <select name="action" class="form-select mb-3">
                    <option value="set">æŒ‡å®šã®æ•°é‡ã«è¨­å®š</option>
                    <option value="add">ç¾åœ¨ã®æ•°é‡ã«åŠ ç®—</option>
                    <option value="subtract">ç¾åœ¨ã®æ•°é‡ã‹ã‚‰æ¸›ç®—</option>
                </select>
                
                <label class="form-label">æ•°é‡</label>
                <input type="number" name="quantity_value" class="form-control" value="1" min="1" max="99" required>
                
                <input type="hidden" name="ingredient_ids[]" id="bulkQuantityIds">
            </form>
        </div>
        <div class="bulk-modal-footer">
            <button class="btn btn-secondary" onclick="closeBulkQuantityModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="submitBulkQuantity()">å¤‰æ›´</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é¸æŠã•ã‚ŒãŸé£Ÿæã®IDã‚’ä¿æŒ
    let selectedIngredients = new Set();

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
    function toggleIngredientSelection(checkbox, ingredientId) {
        const ingredientElement = checkbox.closest('.ingredient-controls');
        
        if (checkbox.checked) {
            selectedIngredients.add(ingredientId);
            ingredientElement.classList.add('selected');
        } else {
            selectedIngredients.delete(ingredientId);
            ingredientElement.classList.remove('selected');
        }
        
        updateBulkActionsBar();
    }

    // ä¸€æ‹¬æ“ä½œãƒãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
    function updateBulkActionsBar() {
        const bar = document.getElementById('bulkActionsBar');
        const count = document.getElementById('selectedCount');
        
        count.textContent = selectedIngredients.size;
        
        if (selectedIngredients.size > 0) {
            bar.classList.add('active');
        } else {
            bar.classList.remove('active');
        }
    }

    // å…¨é¸æŠ/è§£é™¤
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.ingredient-checkbox:not([disabled])');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
            const ingredientId = parseInt(checkbox.dataset.ingredientId);
            
            if (allChecked) {
                checkbox.checked = false;
                selectedIngredients.delete(ingredientId);
                checkbox.closest('.ingredient-controls').classList.remove('selected');
            } else {
                checkbox.checked = true;
                selectedIngredients.add(ingredientId);
                checkbox.closest('.ingredient-controls').classList.add('selected');
            }
        });
        
        document.getElementById('selectAllText').textContent = allChecked ? 'å…¨é¸æŠ' : 'é¸æŠè§£é™¤';
        updateBulkActionsBar();
    }

    // é¸æŠè§£é™¤
    function clearSelection() {
        document.querySelectorAll('.ingredient-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.ingredient-controls').classList.remove('selected');
        });
        selectedIngredients.clear();
        updateBulkActionsBar();
        document.getElementById('selectAllText').textContent = 'å…¨é¸æŠ';
    }

    // ä¸€æ‹¬å‰Šé™¤
    function bulkDelete() {
        if (selectedIngredients.size === 0) {
            alert('å‰Šé™¤ã™ã‚‹é£Ÿæã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!confirm(`${selectedIngredients.size}ä»¶ã®é£Ÿæã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("recipe_app.bulk_delete") }}';
        
        selectedIngredients.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ingredient_ids[]';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }

    // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openBulkCategoryModal() {
        if (selectedIngredients.size === 0) {
            alert('ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´ã™ã‚‹é£Ÿæã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        document.getElementById('bulkCategoryModal').classList.add('active');
    }

    function closeBulkCategoryModal() {
        document.getElementById('bulkCategoryModal').classList.remove('active');
    }

    function submitBulkCategory() {
        const form = document.getElementById('bulkCategoryForm');
        
        // æ—¢å­˜ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
        form.querySelectorAll('input[name="ingredient_ids[]"]').forEach(el => el.remove());
        
        // é¸æŠã•ã‚ŒãŸé£ŸæIDã‚’è¿½åŠ 
        selectedIngredients.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ingredient_ids[]';
            input.value = id;
            form.appendChild(input);
        });
        
        form.submit();
    }

    // æ•°é‡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openBulkQuantityModal() {
        if (selectedIngredients.size === 0) {
            alert('æ•°é‡ã‚’å¤‰æ›´ã™ã‚‹é£Ÿæã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        document.getElementById('bulkQuantityModal').classList.add('active');
    }

    function closeBulkQuantityModal() {
        document.getElementById('bulkQuantityModal').classList.remove('active');
    }

    function submitBulkQuantity() {
        const form = document.getElementById('bulkQuantityForm');
        
        // æ—¢å­˜ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
        form.querySelectorAll('input[name="ingredient_ids[]"]').forEach(el => el.remove());
        
        // é¸æŠã•ã‚ŒãŸé£ŸæIDã‚’è¿½åŠ 
        selectedIngredients.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ingredient_ids[]';
            input.value = id;
            form.appendChild(input);
        });
        
        form.submit();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.querySelectorAll('.bulk-modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    function showCategory(categoryName) {
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.category-section').forEach(section => {
            section.classList.remove('active');
        });
        
        event.target.classList.add('active');
        document.getElementById('category-' + categoryName).classList.add('active');
        
        console.log('ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ:', categoryName);
    }

    // ã‚«ãƒ†ã‚´ãƒªç·¨é›†æ©Ÿèƒ½
    function toggleCategoryEdit(ingredientId) {
        const displayElement = document.querySelector(`.category-display-${ingredientId}`);
        const formElement = document.querySelector(`.category-edit-form-${ingredientId}`);
        
        if (displayElement && formElement) {
            if (formElement.classList.contains('d-none')) {
                displayElement.style.display = 'none';
                formElement.classList.remove('d-none');
                formElement.style.display = 'inline';
                
                const selectElement = formElement.querySelector('select');
                if (selectElement) {
                    selectElement.focus();
                }
            } else {
                displayElement.style.display = 'inline';
                formElement.classList.add('d-none');
                formElement.style.display = 'none';
            }
        }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.querySelectorAll('.bulk-modal').forEach(modal => {
                modal.classList.remove('active');
            });
            
            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
            document.querySelectorAll('[class*="category-edit-form-"]').forEach(form => {
                if (!form.classList.contains('d-none')) {
                    const ingredientId = form.className.match(/category-edit-form-(\d+)/)[1];
                    toggleCategoryEdit(parseInt(ingredientId));
                }
            });
        }
        
        // Ctrl/Cmd + A ã§å…¨é¸æŠ
        if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
            const focusedElement = document.activeElement;
            if (focusedElement.tagName !== 'INPUT' && focusedElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                toggleSelectAll();
            }
        }
        
        // æ•°å­—ã‚­ãƒ¼ã§ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        if (e.key >= '1' && e.key <= '7') {
            const tabs = document.querySelectorAll('.category-tab');
            const index = parseInt(e.key) - 1;
            if (tabs[index]) {
                tabs[index].click();
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log('â„ï¸ Refrigerator page with bulk operations loaded');
        console.log('ğŸ“¦ Total ingredients:', {{ ingredients|length }});
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.querySelectorAll('.ingredient-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                toggleIngredientSelection(this, parseInt(this.dataset.ingredientId));
            });
        });
        
        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®çµ±è¨ˆã‚’è¨ˆç®—
        const categoryStats = {};
        {% for category, items in grouped.items() %}
            categoryStats['{{ category }}'] = {
                count: {{ items|length }},
                totalQuantity: {{ items|sum(attribute='quantity') }}
            };
        {% endfor %}
        
        console.log('ğŸ“Š Category stats:', categoryStats);
    });

    // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œã®ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½
    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleGesture();
    });

    function handleGesture() {
        const swipeThreshold = 50;
        const activeTab = document.querySelector('.category-tab.active');
        const tabs = Array.from(document.querySelectorAll('.category-tab'));
        const currentIndex = tabs.indexOf(activeTab);
        
        if (touchEndX < touchStartX - swipeThreshold) {
            if (currentIndex < tabs.length - 1) {
                tabs[currentIndex + 1].click();
            }
        }
        
        if (touchEndX > touchStartX + swipeThreshold) {
            if (currentIndex > 0) {
                tabs[currentIndex - 1].click();
            }
        }
    }
    </script>
{% endblock %}