{% extends "base.html" %}

{% block title %}冷蔵庫 - レシピ検索アプリ{% endblock %}
{% block page_title %}冷蔵庫{% endblock %}


{% block content %}
{% if ingredients %}
    <!-- 一括操作バー -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <div class="bulk-actions-header">
            <div class="selected-count">
                <span id="selectedCount">0</span>件選択中
            </div>
            <button class="btn btn-sm btn-light" onclick="clearSelection()">選択解除</button>
        </div>
        <div class="bulk-action-buttons">
            <button class="btn btn-sm" onclick="openBulkCategoryModal()">
                📂 カテゴリ変更
            </button>
            <button class="btn btn-sm" onclick="openBulkQuantityModal()">
                🔢 数量変更
            </button>
            <button class="btn btn-sm btn-danger" onclick="bulkDelete()">
                🗑️ 一括削除
            </button>
        </div>
    </div>

    <!-- ソートボタン -->
    <div class="section-card">
        <div class="section-title">
            🔧 表示順序
            <button class="btn btn-sm btn-outline-primary select-all-btn" onclick="toggleSelectAll()">
                <span id="selectAllText">全選択</span>
            </button>
        </div>
        <div class="sort-buttons">
            <a href="{{ url_for('recipe_app.refrigerator') }}" 
               class="btn {{ 'btn-primary' if not sort else 'btn-outline-secondary' }} btn-sm">
                登録順
            </a>
            <a href="{{ url_for('recipe_app.refrigerator', sort='expiry') }}" 
               class="btn {{ 'btn-primary' if sort == 'expiry' else 'btn-outline-secondary' }} btn-sm">
                賞味期限順
            </a>
            <a href="{{ url_for('recipe_app.refrigerator', sort='name') }}" 
               class="btn {{ 'btn-primary' if sort == 'name' else 'btn-outline-secondary' }} btn-sm">
                名前順
            </a>
            <a href="{{ url_for('recipe_app.refrigerator', sort='quantity') }}" 
               class="btn {{ 'btn-primary' if sort == 'quantity' else 'btn-outline-secondary' }} btn-sm">
                数量順
            </a>
        </div>
    </div>

    <!-- カテゴリタブ -->
    <div class="section-card">
        <div class="category-tabs">
            <button class="category-tab all-tab active" onclick="showCategory('all')">
                📦 すべて
                <span class="badge">{{ ingredients|length }}</span>
            </button>
            
            {% for category in all_categories %}
                {% set category_items = grouped.get(category, []) %}
                {% if category_items %}
                <button class="category-tab" onclick="showCategory('{{ category }}')">
                    {% if category == '野菜' %}🥕
                    {% elif category == '肉類' %}🥩
                    {% elif category == '魚介類' %}🐟
                    {% elif category == '乳製品' %}🥛
                    {% elif category == '穀類' %}🌾
                    {% elif category == '調味料' %}🧂
                    {% else %}📦
                    {% endif %}
                    {{ category }}
                    <span class="badge">{{ category_items|length }}</span>
                </button>
                {% endif %}
            {% endfor %}
        </div>

        <!-- タブコンテンツ -->
        <div class="tab-content">
            <!-- 全て表示セクション -->
            <div id="category-all" class="category-section active">
                <div class="category-header">
                    <h3 class="category-title">📦 すべての食材</h3>
                    <div class="category-stats">
                        合計 {{ ingredients|length }} 種類
                    </div>
                </div>
                
                {% for category, items in grouped.items() %}
                    <h5 class="mt-3">
                        {{ category }}
                        <small class="text-muted">({{ items|length }}件)</small>
                    </h5>
                    {% include 'ingredient_list.html' %}
                {% endfor %}
            </div>

            <!-- カテゴリ別セクション -->
            {% for category in all_categories %}
                {% set category_items = grouped.get(category, []) %}
                {% if category_items %}
                <div id="category-{{ category }}" class="category-section">
                    <div class="category-header">
                        <h3 class="category-title">
                            {% if category == '野菜' %}🥕
                            {% elif category == '肉類' %}🥩
                            {% elif category == '魚介類' %}🐟
                            {% elif category == '乳製品' %}🥛
                            {% elif category == '穀類' %}🌾
                            {% elif category == '調味料' %}🧂
                            {% else %}📦
                            {% endif %}
                            {{ category }}
                        </h3>
                        <div class="category-stats">
                            {{ category_items|length }} 種類 / 
                            {% set total_quantity = category_items|sum(attribute='quantity') %}
                            合計 {{ total_quantity }} 個
                        </div>
                    </div>
                    
                    {% set items = category_items %}
                    {% include 'ingredient_list.html' %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- 統計情報 -->
    {% set ns = namespace(expired_count=0, expiring_soon_count=0, total_quantity=0) %}
    {% for ing in ingredients %}
        {% set ns.total_quantity = ns.total_quantity + ing.quantity %}
        {% if ing.expiry_date %}
            {% set days_left = (ing.expiry_date - date.today()).days %}
            {% if days_left < 0 %}
                {% set ns.expired_count = ns.expired_count + 1 %}
            {% elif days_left <= 3 %}
                {% set ns.expiring_soon_count = ns.expiring_soon_count + 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    
    <div class="section-card">
        <div class="section-title">📊 統計情報</div>
        <div class="row text-center">
            <div class="col-6 col-md-3">
                <div class="fw-bold text-primary">{{ ingredients|length }}</div>
                <small class="text-muted">種類</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="fw-bold text-success">{{ ns.total_quantity }}</div>
                <small class="text-muted">総数量</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="fw-bold text-warning">{{ ns.expiring_soon_count }}</div>
                <small class="text-muted">期限間近</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="fw-bold text-danger">{{ ns.expired_count }}</div>
                <small class="text-muted">期限切れ</small>
            </div>
        </div>
    </div>
    
    <!-- クイックアクション -->
    <div class="section-card">
        <div class="section-title">🚀 アクション</div>
        <div class="d-grid gap-2 d-md-flex">
            <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-success">
                食材を追加
            </a>
            <a href="{{ url_for('recipe_app.search') }}" class="btn btn-primary">
                レシピを検索
            </a>
        </div>
    </div>
    
{% else %}
    <!-- 空の状態 -->
    <div class="empty-state">
        <div class="empty-state-icon">❄️</div>
        <h5>冷蔵庫が空っぽです</h5>
        <p>まずは食材を登録して、<br>冷蔵庫管理を始めましょう。</p>
        <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-primary">
            最初の食材を登録
        </a>
    </div>
{% endif %}

<!-- カテゴリ変更モーダル -->
<div class="bulk-modal" id="bulkCategoryModal">
    <div class="bulk-modal-content">
        <div class="bulk-modal-header">カテゴリを一括変更</div>
        <div class="bulk-modal-body">
            <form id="bulkCategoryForm" method="POST" action="{{ url_for('recipe_app.bulk_change_category') }}">
                <label class="form-label">変更先のカテゴリ</label>
                <select name="new_category" class="form-select" required>
                    {% for cat in all_categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="ingredient_ids[]" id="bulkCategoryIds">
            </form>
        </div>
        <div class="bulk-modal-footer">
            <button class="btn btn-secondary" onclick="closeBulkCategoryModal()">キャンセル</button>
            <button class="btn btn-primary" onclick="submitBulkCategory()">変更</button>
        </div>
    </div>
</div>

<!-- 数量変更モーダル -->
<div class="bulk-modal" id="bulkQuantityModal">
    <div class="bulk-modal-content">
        <div class="bulk-modal-header">数量を一括変更</div>
        <div class="bulk-modal-body">
            <form id="bulkQuantityForm" method="POST" action="{{ url_for('recipe_app.bulk_change_quantity') }}">
                <label class="form-label">操作</label>
                <select name="action" class="form-select mb-3">
                    <option value="set">指定の数量に設定</option>
                    <option value="add">現在の数量に加算</option>
                    <option value="subtract">現在の数量から減算</option>
                </select>
                
                <label class="form-label">数量</label>
                <input type="number" name="quantity_value" class="form-control" value="1" min="1" max="99" required>
                
                <input type="hidden" name="ingredient_ids[]" id="bulkQuantityIds">
            </form>
        </div>
        <div class="bulk-modal-footer">
            <button class="btn btn-secondary" onclick="closeBulkQuantityModal()">キャンセル</button>
            <button class="btn btn-primary" onclick="submitBulkQuantity()">変更</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 選択された食材のIDを保持
    let selectedIngredients = new Set();

    // チェックボックスの変更を監視
    function toggleIngredientSelection(checkbox, ingredientId) {
        const ingredientElement = checkbox.closest('.ingredient-controls');
        
        if (checkbox.checked) {
            selectedIngredients.add(ingredientId);
            ingredientElement.classList.add('selected');
        } else {
            selectedIngredients.delete(ingredientId);
            ingredientElement.classList.remove('selected');
        }
        
        updateBulkActionsBar();
    }

    // 一括操作バーの表示/非表示
    function updateBulkActionsBar() {
        const bar = document.getElementById('bulkActionsBar');
        const count = document.getElementById('selectedCount');
        
        count.textContent = selectedIngredients.size;
        
        if (selectedIngredients.size > 0) {
            bar.classList.add('active');
        } else {
            bar.classList.remove('active');
        }
    }

    // 全選択/解除
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.ingredient-checkbox:not([disabled])');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
            const ingredientId = parseInt(checkbox.dataset.ingredientId);
            
            if (allChecked) {
                checkbox.checked = false;
                selectedIngredients.delete(ingredientId);
                checkbox.closest('.ingredient-controls').classList.remove('selected');
            } else {
                checkbox.checked = true;
                selectedIngredients.add(ingredientId);
                checkbox.closest('.ingredient-controls').classList.add('selected');
            }
        });
        
        document.getElementById('selectAllText').textContent = allChecked ? '全選択' : '選択解除';
        updateBulkActionsBar();
    }

    // 選択解除
    function clearSelection() {
        document.querySelectorAll('.ingredient-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.ingredient-controls').classList.remove('selected');
        });
        selectedIngredients.clear();
        updateBulkActionsBar();
        document.getElementById('selectAllText').textContent = '全選択';
    }

    // 一括削除
    function bulkDelete() {
        if (selectedIngredients.size === 0) {
            alert('削除する食材を選択してください');
            return;
        }
        
        if (!confirm(`${selectedIngredients.size}件の食材を削除しますか？この操作は取り消せません。`)) {
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("recipe_app.bulk_delete") }}';
        
        selectedIngredients.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ingredient_ids[]';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }

    // カテゴリ変更モーダル
    function openBulkCategoryModal() {
        if (selectedIngredients.size === 0) {
            alert('カテゴリを変更する食材を選択してください');
            return;
        }
        document.getElementById('bulkCategoryModal').classList.add('active');
    }

    function closeBulkCategoryModal() {
        document.getElementById('bulkCategoryModal').classList.remove('active');
    }

    function submitBulkCategory() {
        const form = document.getElementById('bulkCategoryForm');
        
        // 既存の隠しフィールドを削除
        form.querySelectorAll('input[name="ingredient_ids[]"]').forEach(el => el.remove());
        
        // 選択された食材IDを追加
        selectedIngredients.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ingredient_ids[]';
            input.value = id;
            form.appendChild(input);
        });
        
        form.submit();
    }

    // 数量変更モーダル
    function openBulkQuantityModal() {
        if (selectedIngredients.size === 0) {
            alert('数量を変更する食材を選択してください');
            return;
        }
        document.getElementById('bulkQuantityModal').classList.add('active');
    }

    function closeBulkQuantityModal() {
        document.getElementById('bulkQuantityModal').classList.remove('active');
    }

    function submitBulkQuantity() {
        const form = document.getElementById('bulkQuantityForm');
        
        // 既存の隠しフィールドを削除
        form.querySelectorAll('input[name="ingredient_ids[]"]').forEach(el => el.remove());
        
        // 選択された食材IDを追加
        selectedIngredients.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ingredient_ids[]';
            input.value = id;
            form.appendChild(input);
        });
        
        form.submit();
    }

    // モーダル外クリックで閉じる
    document.querySelectorAll('.bulk-modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // タブ切り替え機能
    function showCategory(categoryName) {
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.category-section').forEach(section => {
            section.classList.remove('active');
        });
        
        event.target.classList.add('active');
        document.getElementById('category-' + categoryName).classList.add('active');
        
        console.log('カテゴリ切り替え:', categoryName);
    }

    // カテゴリ編集機能
    function toggleCategoryEdit(ingredientId) {
        const displayElement = document.querySelector(`.category-display-${ingredientId}`);
        const formElement = document.querySelector(`.category-edit-form-${ingredientId}`);
        
        if (displayElement && formElement) {
            if (formElement.classList.contains('d-none')) {
                displayElement.style.display = 'none';
                formElement.classList.remove('d-none');
                formElement.style.display = 'inline';
                
                const selectElement = formElement.querySelector('select');
                if (selectElement) {
                    selectElement.focus();
                }
            } else {
                displayElement.style.display = 'inline';
                formElement.classList.add('d-none');
                formElement.style.display = 'none';
            }
        }
    }

    // キーボードショートカット
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // モーダルを閉じる
            document.querySelectorAll('.bulk-modal').forEach(modal => {
                modal.classList.remove('active');
            });
            
            // 編集フォームを閉じる
            document.querySelectorAll('[class*="category-edit-form-"]').forEach(form => {
                if (!form.classList.contains('d-none')) {
                    const ingredientId = form.className.match(/category-edit-form-(\d+)/)[1];
                    toggleCategoryEdit(parseInt(ingredientId));
                }
            });
        }
        
        // Ctrl/Cmd + A で全選択
        if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
            const focusedElement = document.activeElement;
            if (focusedElement.tagName !== 'INPUT' && focusedElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                toggleSelectAll();
            }
        }
        
        // 数字キーでタブ切り替え
        if (e.key >= '1' && e.key <= '7') {
            const tabs = document.querySelectorAll('.category-tab');
            const index = parseInt(e.key) - 1;
            if (tabs[index]) {
                tabs[index].click();
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log('❄️ Refrigerator page with bulk operations loaded');
        console.log('📦 Total ingredients:', {{ ingredients|length }});
        
        // チェックボックスのイベントリスナー設定
        document.querySelectorAll('.ingredient-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                toggleIngredientSelection(this, parseInt(this.dataset.ingredientId));
            });
        });
        
        // カテゴリ別の統計を計算
        const categoryStats = {};
        {% for category, items in grouped.items() %}
            categoryStats['{{ category }}'] = {
                count: {{ items|length }},
                totalQuantity: {{ items|sum(attribute='quantity') }}
            };
        {% endfor %}
        
        console.log('📊 Category stats:', categoryStats);
    });

    // タッチデバイス対応のスワイプ機能
    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleGesture();
    });

    function handleGesture() {
        const swipeThreshold = 50;
        const activeTab = document.querySelector('.category-tab.active');
        const tabs = Array.from(document.querySelectorAll('.category-tab'));
        const currentIndex = tabs.indexOf(activeTab);
        
        if (touchEndX < touchStartX - swipeThreshold) {
            if (currentIndex < tabs.length - 1) {
                tabs[currentIndex + 1].click();
            }
        }
        
        if (touchEndX > touchStartX + swipeThreshold) {
            if (currentIndex > 0) {
                tabs[currentIndex - 1].click();
            }
        }
    }
    </script>
{% endblock %}