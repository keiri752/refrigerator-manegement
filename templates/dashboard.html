{% extends "base.html" %}

{% block title %}ãƒ›ãƒ¼ãƒ  - ãƒ¬ã‚·ãƒ”æ¤œç´¢ã‚¢ãƒ—ãƒª{% endblock %}
{% block page_title %}ãƒ›ãƒ¼ãƒ {% endblock %}



{% block content %}
<!-- çµ±è¨ˆæƒ…å ± -->
<div class="stats-card">
    <div class="stats-number">{{ total_ingredients }}</div>
    <div class="stats-label">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹é£Ÿæ</div>
</div>

<!-- è³å‘³æœŸé™é€šçŸ¥ -->
{% if notifications.expired or notifications.expiring_soon or notifications.expiring_week %}
    <div class="section-card">
        <div class="section-title">ğŸ”” ãŠçŸ¥ã‚‰ã›</div>
        
        {% if notifications.expired %}
            <div class="notification-card danger card p-3">
                <h6 class="text-danger mb-2">âš ï¸ è³å‘³æœŸé™åˆ‡ã‚Œã®é£ŸæãŒã‚ã‚Šã¾ã™</h6>
                <div class="small">
                    {% for ing in notifications.expired %}
                        <span class="badge bg-danger me-1">{{ ing.name }}</span>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('recipe_app.refrigerator') }}" class="btn btn-sm btn-danger">ç¢ºèªã™ã‚‹</a>
                </div>
            </div>
        {% endif %}
        
        {% if notifications.expiring_soon %}
            <div class="notification-card warning card p-3">
                <h6 class="text-warning mb-2">â° 3æ—¥ä»¥å†…ã«æœŸé™åˆ‡ã‚Œã«ãªã‚‹é£Ÿæ</h6>
                <div class="small">
                    {% for ing in notifications.expiring_soon %}
                        {% set days_left = (ing.expiry_date - date.today()).days %}
                        <span class="badge bg-warning me-1">
                            {{ ing.name }} ({{ days_left }}æ—¥)
                        </span>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('recipe_app.search') }}" class="btn btn-sm btn-warning">ãƒ¬ã‚·ãƒ”ã‚’æ¢ã™</a>
                </div>
            </div>
        {% endif %}
        
        {% if notifications.expiring_week %}
            <div class="notification-card info card p-3">
                <h6 class="text-info mb-2">ğŸ“… 1é€±é–“ä»¥å†…ã«æœŸé™åˆ‡ã‚Œã«ãªã‚‹é£Ÿæ</h6>
                <div class="small">
                    {% for ing in notifications.expiring_week %}
                        {% set days_left = (ing.expiry_date - date.today()).days %}
                        <span class="badge bg-info me-1">
                            {{ ing.name }} ({{ days_left }}æ—¥)
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
{% else %}
    <div class="section-card">
        <div class="section-title">âœ… ã™ã¹ã¦è‰¯å¥½ã§ã™</div>
        <p class="text-muted mb-0">è³å‘³æœŸé™ã®å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>
{% endif %}

<!-- ãŠã™ã™ã‚ãƒ¬ã‚·ãƒ”ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
{% if recommended_recipes %}
<div class="recipe-recommendations">
    <div class="section-title text-white mb-3">ğŸ³ æœŸé™åˆ‡ã‚Œé–“è¿‘ã®é£Ÿæã§ãŠã™ã™ã‚ãƒ¬ã‚·ãƒ”</div>
    <p class="text-white-50 mb-3 small">è³å‘³æœŸé™ãŒè¿‘ã„é£Ÿæã‚’ä½¿ã£ã¦ã€ä»Šã™ãä½œã‚Œã‚‹ãƒ¬ã‚·ãƒ”ã‚’ã”ææ¡ˆã—ã¾ã™</p>
    
    {% for recipe in recommended_recipes %}
    <div class="recipe-card">
        {% if recipe.img %}
            <img src="{{ recipe.img }}" alt="{{ recipe.title }}" class="recipe-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="no-image-placeholder" style="display: none;">ğŸ½ï¸</div>
        {% else %}
            <div class="no-image-placeholder">ğŸ½ï¸</div>
        {% endif %}
        
        <div class="recipe-content">
            <div class="recipe-title">{{ recipe.title }}</div>
            <div class="recipe-meta">
                <strong>{{ recipe.source }}</strong>
                {% if recipe.ingredient_used %}
                    â€¢ <span class="recipe-ingredient-tag">{{ recipe.ingredient_used }}ä½¿ç”¨</span>
                {% endif %}
            </div>
            <div class="recipe-actions">
                <a href="{{ recipe.url }}" target="_blank" class="btn btn-primary btn-sm btn-recipe">ãƒ¬ã‚·ãƒ”ã‚’è¦‹ã‚‹</a>
                <button type="button" class="btn btn-outline-secondary btn-sm btn-recipe" 
                        onclick="shareRecipe('{{ recipe.title }}', '{{ recipe.url }}')">ã‚·ã‚§ã‚¢</button>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <div class="text-center mt-3">
        <a href="{{ url_for('recipe_app.search') }}" class="btn btn-light btn-sm">
            ã‚‚ã£ã¨ãƒ¬ã‚·ãƒ”ã‚’æ¢ã™ â†’
        </a>
    </div>
</div>
{% endif %}

<!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="section-card">
    <div class="section-title">ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div class="quick-actions">
        <a href="{{ url_for('recipe_app.add_ingredient') }}" class="action-btn">
            <span class="action-icon">â•</span>
            <div>é£Ÿæè¿½åŠ </div>
        </a>
        <a href="{{ url_for('recipe_app.search') }}" class="action-btn">
            <span class="action-icon">ğŸ”</span>
            <div>ãƒ¬ã‚·ãƒ”æ¤œç´¢</div>
        </a>
        <a href="{{ url_for('recipe_app.refrigerator') }}" class="action-btn">
            <span class="action-icon">â„ï¸</span>
            <div>å†·è”µåº«</div>
        </a>
        <a href="{{ url_for('recipe_app.refrigerator', sort='expiry') }}" class="action-btn">
            <span class="action-icon">â°</span>
            <div>æœŸé™é †è¡¨ç¤º</div>
        </a>
    </div>
</div>

<!-- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ï¼ˆåˆå›ï¼‰ -->
{% if total_ingredients == 0 %}
    <div class="section-card" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
        <div class="section-title text-white">ğŸ‘‹ ã¯ã˜ã‚ã¦ã®æ–¹ã¸</div>
        <div class="mb-3">
            <h6>1. é£Ÿæã‚’ç™»éŒ²ã—ã‚ˆã†</h6>
            <p class="small mb-2">å†·è”µåº«ã«ã‚ã‚‹é£Ÿæã‚’ã€Œè¿½åŠ ã€ãƒšãƒ¼ã‚¸ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
            
            <h6>2. ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢ã—ã‚ˆã†</h6>
            <p class="small mb-2">ç™»éŒ²ã—ãŸé£Ÿæã‹ã‚‰ãŠã„ã—ã„ãƒ¬ã‚·ãƒ”ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚</p>
            
            <h6>3. è³å‘³æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯</h6>
            <p class="small mb-0">æœŸé™ãŒè¿‘ã„é£Ÿæã¯è‡ªå‹•ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚</p>
        </div>
        <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-light">
            ä»Šã™ãå§‹ã‚ã‚‹
        </a>
    </div>
{% endif %}
<!-- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è¨­å®šã‚«ãƒ¼ãƒ‰ -->
    <div class="section-card">
        <div class="section-title">ğŸ”” ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è¨­å®š</div>
        <p class="text-muted small mb-3">è³å‘³æœŸé™ãŒè¿‘ã¥ã„ãŸã¨ãã«é€šçŸ¥ã‚’å—ã‘å–ã‚Œã¾ã™</p>
    
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>é€šçŸ¥çŠ¶æ…‹: <span id="pushNotificationStatus" class="badge bg-secondary">æœªè¨­å®š</span></span>
        </div>
    
        <button id="pushNotificationToggle" class="btn btn-primary w-100 mb-2" onclick="togglePushNotification()">
            ğŸ”” é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹
        </button>
    
        <button id="testNotificationBtn" class="btn btn-outline-secondary w-100" onclick="sendTestNotification()" style="display: none;">
        ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
        </button>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // ãƒ¬ã‚·ãƒ”ã‚·ã‚§ã‚¢æ©Ÿèƒ½
    function shareRecipe(title, url) {
        if (navigator.share) {
            // Web Share APIå¯¾å¿œã®å ´åˆ
            navigator.share({
                title: title,
                url: url
            }).catch(console.error);
        } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            const shareText = `${title}\n${url}`;
            navigator.clipboard.writeText(shareText).then(() => {
                // ç°¡å˜ãªé€šçŸ¥è¡¨ç¤º
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†!';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 1500);
            }).catch(() => {
                // ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ãŸå ´åˆã€URLã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                window.open(url, '_blank');
            });
        }
    }

    // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ  Dashboard loaded');
        console.log('ğŸ“Š Total ingredients:', {{ total_ingredients }});
        console.log('ğŸ”” Notifications:', {
            expired: {{ notifications.expired|length }},
            expiring_soon: {{ notifications.expiring_soon|length }},
            expiring_week: {{ notifications.expiring_week|length }}
        });
        console.log('ğŸ³ Recommended recipes:', {{ recommended_recipes|length }});

        // ç”»åƒã®é…å»¶èª­ã¿è¾¼ã¿
        const images = document.querySelectorAll('.recipe-image');
        images.forEach(img => {
            img.addEventListener('error', function() {
                this.style.display = 'none';
                const placeholder = this.nextElementSibling;
                if (placeholder && placeholder.classList.contains('no-image-placeholder')) {
                    placeholder.style.display = 'flex';
                }
            });
        });

        // ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯è¿½è·¡
        document.querySelectorAll('.recipe-card').forEach((card, index) => {
            card.addEventListener('click', function(e) {
                if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
                    const link = this.querySelector('a[href]');
                    if (link) {
                        console.log(`Recipe card ${index + 1} clicked`);
                        link.click();
                    }
                }
            });
        });
    });

    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬
    window.addEventListener('load', function() {
        console.log('ğŸ“Š Dashboard performance:', {
            loadTime: performance.now(),
            recipes: {{ recommended_recipes|length }},
            notifications: {{ (notifications.expired|length + notifications.expiring_soon|length + notifications.expiring_week|length) }}
        });
    });
</script>

<script src="/static/js/push-notifications.js"></script>
<script>
async function togglePushNotification() {
    if (pushManager.subscription) {
        await pushManager.unsubscribe();
        document.getElementById('testNotificationBtn').style.display = 'none';
    } else {
        const success = await pushManager.requestPermission();
        if (success) {
            document.getElementById('testNotificationBtn').style.display = 'block';
        }
    }
}

async function sendTestNotification() {
    await pushManager.sendTestNotification();
}
</script>
{% endblock %}