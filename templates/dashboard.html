{% extends "base.html" %}

{% block title %}ホーム - レシピ検索アプリ{% endblock %}
{% block page_title %}ホーム{% endblock %}



{% block content %}
<!-- 統計情報 -->
<div class="stats-card">
    <div class="stats-number">{{ total_ingredients }}</div>
    <div class="stats-label">登録されている食材</div>
</div>

<!-- 賞味期限通知 -->
{% if notifications.expired or notifications.expiring_soon or notifications.expiring_week %}
    <div class="section-card">
        <div class="section-title">🔔 お知らせ</div>
        
        {% if notifications.expired %}
            <div class="notification-card danger card p-3">
                <h6 class="text-danger mb-2">⚠️ 賞味期限切れの食材があります</h6>
                <div class="small">
                    {% for ing in notifications.expired %}
                        <span class="badge bg-danger me-1">{{ ing.name }}</span>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('recipe_app.refrigerator') }}" class="btn btn-sm btn-danger">確認する</a>
                </div>
            </div>
        {% endif %}
        
        {% if notifications.expiring_soon %}
            <div class="notification-card warning card p-3">
                <h6 class="text-warning mb-2">⏰ 3日以内に期限切れになる食材</h6>
                <div class="small">
                    {% for ing in notifications.expiring_soon %}
                        {% set days_left = (ing.expiry_date - date.today()).days %}
                        <span class="badge bg-warning me-1">
                            {{ ing.name }} ({{ days_left }}日)
                        </span>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('recipe_app.search') }}" class="btn btn-sm btn-warning">レシピを探す</a>
                </div>
            </div>
        {% endif %}
        
        {% if notifications.expiring_week %}
            <div class="notification-card info card p-3">
                <h6 class="text-info mb-2">📅 1週間以内に期限切れになる食材</h6>
                <div class="small">
                    {% for ing in notifications.expiring_week %}
                        {% set days_left = (ing.expiry_date - date.today()).days %}
                        <span class="badge bg-info me-1">
                            {{ ing.name }} ({{ days_left }}日)
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
{% else %}
    <div class="section-card">
        <div class="section-title">✅ すべて良好です</div>
        <p class="text-muted mb-0">賞味期限の問題はありません。</p>
    </div>
{% endif %}

<!-- おすすめレシピセクション -->
{% if recommended_recipes %}
<div class="recipe-recommendations">
    <div class="section-title text-white mb-3">🍳 期限切れ間近の食材でおすすめレシピ</div>
    <p class="text-white-50 mb-3 small">賞味期限が近い食材を使って、今すぐ作れるレシピをご提案します</p>
    
    {% for recipe in recommended_recipes %}
    <div class="recipe-card">
        {% if recipe.img %}
            <img src="{{ recipe.img }}" alt="{{ recipe.title }}" class="recipe-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="no-image-placeholder" style="display: none;">🍽️</div>
        {% else %}
            <div class="no-image-placeholder">🍽️</div>
        {% endif %}
        
        <div class="recipe-content">
            <div class="recipe-title">{{ recipe.title }}</div>
            <div class="recipe-meta">
                <strong>{{ recipe.source }}</strong>
                {% if recipe.ingredient_used %}
                    • <span class="recipe-ingredient-tag">{{ recipe.ingredient_used }}使用</span>
                {% endif %}
            </div>
            <div class="recipe-actions">
                <a href="{{ recipe.url }}" target="_blank" class="btn btn-primary btn-sm btn-recipe">レシピを見る</a>
                <button type="button" class="btn btn-outline-secondary btn-sm btn-recipe" 
                        onclick="shareRecipe('{{ recipe.title }}', '{{ recipe.url }}')">シェア</button>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <div class="text-center mt-3">
        <a href="{{ url_for('recipe_app.search') }}" class="btn btn-light btn-sm">
            もっとレシピを探す →
        </a>
    </div>
</div>
{% endif %}

<!-- クイックアクション -->
<div class="section-card">
    <div class="section-title">🚀 クイックアクション</div>
    <div class="quick-actions">
        <a href="{{ url_for('recipe_app.add_ingredient') }}" class="action-btn">
            <span class="action-icon">➕</span>
            <div>食材追加</div>
        </a>
        <a href="{{ url_for('recipe_app.search') }}" class="action-btn">
            <span class="action-icon">🔍</span>
            <div>レシピ検索</div>
        </a>
        <a href="{{ url_for('recipe_app.refrigerator') }}" class="action-btn">
            <span class="action-icon">❄️</span>
            <div>冷蔵庫</div>
        </a>
        <a href="{{ url_for('recipe_app.refrigerator', sort='expiry') }}" class="action-btn">
            <span class="action-icon">⏰</span>
            <div>期限順表示</div>
        </a>
    </div>
</div>

<!-- 使い方ガイド（初回） -->
{% if total_ingredients == 0 %}
    <div class="section-card" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
        <div class="section-title text-white">👋 はじめての方へ</div>
        <div class="mb-3">
            <h6>1. 食材を登録しよう</h6>
            <p class="small mb-2">冷蔵庫にある食材を「追加」ページで登録してください。</p>
            
            <h6>2. レシピを検索しよう</h6>
            <p class="small mb-2">登録した食材からおいしいレシピを見つけられます。</p>
            
            <h6>3. 賞味期限をチェック</h6>
            <p class="small mb-0">期限が近い食材は自動でお知らせします。</p>
        </div>
        <a href="{{ url_for('recipe_app.add_ingredient') }}" class="btn btn-light">
            今すぐ始める
        </a>
    </div>
{% endif %}
<!-- プッシュ通知設定カード -->
    <div class="section-card">
        <div class="section-title">🔔 プッシュ通知設定</div>
        <p class="text-muted small mb-3">賞味期限が近づいたときに通知を受け取れます</p>
    
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>通知状態: <span id="pushNotificationStatus" class="badge bg-secondary">未設定</span></span>
        </div>
    
        <button id="pushNotificationToggle" class="btn btn-primary w-100 mb-2" onclick="togglePushNotification()">
            🔔 通知を許可する
        </button>
    
        <button id="testNotificationBtn" class="btn btn-outline-secondary w-100" onclick="sendTestNotification()" style="display: none;">
        テスト通知を送信
        </button>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // レシピシェア機能
    function shareRecipe(title, url) {
        if (navigator.share) {
            // Web Share API対応の場合
            navigator.share({
                title: title,
                url: url
            }).catch(console.error);
        } else {
            // フォールバック: クリップボードにコピー
            const shareText = `${title}\n${url}`;
            navigator.clipboard.writeText(shareText).then(() => {
                // 簡単な通知表示
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'コピー完了!';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 1500);
            }).catch(() => {
                // コピーに失敗した場合、URLを新しいタブで開く
                window.open(url, '_blank');
            });
        }
    }

    // 画像読み込みエラーのハンドリング
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🏠 Dashboard loaded');
        console.log('📊 Total ingredients:', {{ total_ingredients }});
        console.log('🔔 Notifications:', {
            expired: {{ notifications.expired|length }},
            expiring_soon: {{ notifications.expiring_soon|length }},
            expiring_week: {{ notifications.expiring_week|length }}
        });
        console.log('🍳 Recommended recipes:', {{ recommended_recipes|length }});

        // 画像の遅延読み込み
        const images = document.querySelectorAll('.recipe-image');
        images.forEach(img => {
            img.addEventListener('error', function() {
                this.style.display = 'none';
                const placeholder = this.nextElementSibling;
                if (placeholder && placeholder.classList.contains('no-image-placeholder')) {
                    placeholder.style.display = 'flex';
                }
            });
        });

        // レシピカードのクリック追跡
        document.querySelectorAll('.recipe-card').forEach((card, index) => {
            card.addEventListener('click', function(e) {
                if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
                    const link = this.querySelector('a[href]');
                    if (link) {
                        console.log(`Recipe card ${index + 1} clicked`);
                        link.click();
                    }
                }
            });
        });
    });

    // パフォーマンス計測
    window.addEventListener('load', function() {
        console.log('📊 Dashboard performance:', {
            loadTime: performance.now(),
            recipes: {{ recommended_recipes|length }},
            notifications: {{ (notifications.expired|length + notifications.expiring_soon|length + notifications.expiring_week|length) }}
        });
    });
</script>

<script src="/static/js/push-notifications.js"></script>
<script>
async function togglePushNotification() {
    if (pushManager.subscription) {
        await pushManager.unsubscribe();
        document.getElementById('testNotificationBtn').style.display = 'none';
    } else {
        const success = await pushManager.requestPermission();
        if (success) {
            document.getElementById('testNotificationBtn').style.display = 'block';
        }
    }
}

async function sendTestNotification() {
    await pushManager.sendTestNotification();
}
</script>
{% endblock %}