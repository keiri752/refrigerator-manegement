{% for ing in items %}
    {% set color_class = "" %}
    {% set status_text = "" %}
    {% if ing.expiry_date %}
        {% set days_left = (ing.expiry_date - date.today()).days %}
        {% if days_left < 0 %}
            {% set color_class = "text-danger fw-bold" %}
            {% set status_text = "æœŸé™åˆ‡ã‚Œ" %}
        {% elif days_left == 0 %}
            {% set color_class = "text-danger fw-bold" %}
            {% set status_text = "ä»Šæ—¥ã¾ã§" %}
        {% elif days_left <= 3 %}
            {% set color_class = "text-danger" %}
            {% set status_text = days_left ~ "æ—¥å¾Œ" %}
        {% elif days_left <= 7 %}
            {% set color_class = "text-warning" %}
            {% set status_text = days_left ~ "æ—¥å¾Œ" %}
        {% else %}
            {% set color_class = "text-success" %}
            {% set status_text = days_left ~ "æ—¥å¾Œ" %}
        {% endif %}
    {% endif %}

    <div class="ingredient-controls" id="ingredient-{{ ing.id }}">
        <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
        <input type="checkbox" 
               class="ingredient-checkbox" 
               data-ingredient-id="{{ ing.id }}"
               id="checkbox-{{ ing.id }}">
        
        <div style="flex: 1;">
            <div class="ingredient-name {{ color_class }}">
                {{ ing.name }}
                <button type="button" 
                        class="btn btn-sm btn-outline-secondary ms-2" 
                        onclick="toggleCategoryEdit({{ ing.id }})"
                        title="ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´">
                    ğŸ·ï¸
                </button>
            </div>
            
            <!-- ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤º/ç·¨é›† -->
            <div class="ingredient-category">
                <span class="category-display-{{ ing.id }}">
                    <small class="text-muted">ğŸ“‚ {{ ing.category }}</small>
                </span>
                
                <!-- ã‚«ãƒ†ã‚´ãƒªç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form class="category-edit-form-{{ ing.id }} d-none" 
                      action="{{ url_for('edit_category', id=ing.id) }}" 
                      method="post" 
                      style="display: inline;">
                    <select name="category" class="form-select form-select-sm d-inline-block w-auto">
                        {% for cat in all_categories %}
                        <option value="{{ cat }}" {% if cat == ing.category %}selected{% endif %}>
                            {{ cat }}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-success">ä¿å­˜</button>
                    <button type="button" 
                            class="btn btn-sm btn-secondary" 
                            onclick="toggleCategoryEdit({{ ing.id }})">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </form>
            </div>
            
            <div class="ingredient-info">
                {% if ing.expiry_date %}
                    {{ ing.expiry_date.strftime("%Y/%m/%d") }} ({{ status_text }})
                {% else %}
                    è³å‘³æœŸé™æœªè¨­å®š
                {% endif %}
            </div>
        </div>

        <!-- æ•°é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="quantity-controls">
            <form action="{{ url_for('change_quantity', id=ing.id, action='minus') }}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-outline-secondary btn-sm btn-quantity">âˆ’</button>
            </form>
            <span class="mx-2 fw-bold">{{ ing.quantity }}</span>
            <form action="{{ url_for('change_quantity', id=ing.id, action='plus') }}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-outline-secondary btn-sm btn-quantity">+</button>
            </form>
            <a href="{{ url_for('delete_ingredient', id=ing.id) }}" 
               class="btn btn-outline-danger btn-sm ms-2"
               onclick="return confirm('{{ ing.name }}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">ğŸ—‘</a>
        </div>
    </div>
{% endfor %}